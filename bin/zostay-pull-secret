#!/bin/zsh

# Pull a secret from LastPass and store it locally using the local secret key to
# keep them (weakly) encoded locally.

umask 0077
if [ ! -d ~/.secrets ]; then
    mkdir ~/.secrets
fi

FAIL=0
[[ $ZOSTAY_SECRETS_SKIP_LOGIN = "YES" ]] || lpass login $LPASS_USERNAME || exit 1

lpass show --sync=now "$1" | grep 'Multiple matches' && FAIL=2
(( $FAIL )) \
    || lpass show --sync=no --password "$1" >! ~/.secrets/"$1" \
    || FAIL=3

[[ $ZOSTAY_SECRETS_SKIP_LOGIN = "YES" ]] || lpass logout --force
(( $FAIL )) && echo Failed to pull '"'$1'"' >&2
exit $FAIL
