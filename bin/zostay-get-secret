#!/bin/zsh

# If the secret is local already, say it. If not, check to see if we have a tty.
# If we do, pull the secret and then say it. Otherwise, mark it for sync and
# then complain with instructions.

umask 0077
if [ ! -d ~/.secrets ]; then
    mkdir ~/.secrets
fi

if [ -e ~/.secrets/"$1" ]; then
    cat ~/.secrets/"$1"
elif [ -t 1 ]; then
    bin/zostay-pull-secret "$1"
    cat ~/.secrets/"$1"
else
    if [ -e ~/.secrets/.new ]; then
        grep -v "$1" ~/.secrets/.new >! ~/.secrets/.tmp
        mv -f ~/.secrets/.tmp ~/.secrets/.new
    fi
    echo $1 >>! ~/.secrets/.new
    echo Run zostay-sync-secrets when you have the chance and relog. >&2
fi
